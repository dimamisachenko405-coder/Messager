rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -------------------------------------------------------------------------
    // Helper Functions
    // -------------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isChatParticipant(chatId) {
      return isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participantIds;
    }

    // -------------------------------------------------------------------------
    // User Profile Rules
    // -------------------------------------------------------------------------

    match /userProfiles/{userId} {
      allow read: if isSignedIn();
      allow create: if isOwner(userId) && request.resource.data.uid == userId;
      allow update: if isOwner(userId) && request.resource.data.uid == resource.data.uid;
      allow delete: if isOwner(userId);
    }

    match /userProfiles/{ownerUserId}/contacts/{contactId} {
      allow read, list: if isOwner(ownerUserId);
      allow create: if isOwner(ownerUserId) && request.resource.data.ownerUserId == ownerUserId;
      allow update: if isOwner(ownerUserId) && request.resource.data.ownerUserId == resource.data.ownerUserId;
      allow delete: if isOwner(ownerUserId);
    }

    // -------------------------------------------------------------------------
    // Chat Rules
    // -------------------------------------------------------------------------

    match /chats/{chatId} {
      // Any participant can get the chat document.
      allow get: if isChatParticipant(chatId);
      // Listing chats is complex. For now, allow any signed-in user to list,
      // but client-side queries should filter to only show relevant chats.
      allow list: if isSignedIn();
      // A user can create a chat if they are a participant in the new chat.
      allow create: if isChatParticipant(chatId) && request.resource.data.id == chatId;
      // A participant can update chat metadata (e.g. lastMessage).
      allow update: if isChatParticipant(chatId);
      // A participant can delete a chat.
      allow delete: if isChatParticipant(chatId);
    }

    /**
     * @description Secures messages within a chat.
     * @path /chats/{chatId}/messages/{messageId}
     */
    match /chats/{chatId}/messages/{messageId} {
      // Reading messages is allowed for any participant of the chat.
      allow get, list: if isChatParticipant(chatId);
      
      // Creating a message is allowed if you are a participant and the sender.
      allow create: if isChatParticipant(chatId) && request.resource.data.senderId == request.auth.uid;
      
      // *** MODIFIED RULE ***
      // Updating a message is allowed for two scenarios:
      // 1. The original sender can edit their own message content.
      // 2. The receiver (any other chat participant) can mark the message as read.
      allow update: if isChatParticipant(chatId) && (
        // Case 1: Sender is editing their own message.
        (resource.data.senderId == request.auth.uid) ||
        // Case 2: Receiver is marking the message as read.
        (
          request.auth.uid != resource.data.senderId && // Must not be the sender
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isRead']) && // ONLY the 'isRead' field can be changed
          request.resource.data.isRead == true // The change must be to 'true'
        )
      );
      
      // Deleting a message is restricted to the original sender.
      allow delete: if isChatParticipant(chatId) && resource.data.senderId == request.auth.uid;
    }

    match /chats/{chatId}/messages/{messageId}/attachments/{attachmentId} {
      allow get, list: if isChatParticipant(chatId);
      allow create: if isChatParticipant(chatId) && request.resource.data.messageId == messageId;
      allow update: if isChatParticipant(chatId) && request.resource.data.messageId == resource.data.messageId;
      allow delete: if isChatParticipant(chatId);
    }
  }
}
